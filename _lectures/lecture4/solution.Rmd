---
title: "lecture4 solution notes"
author: "Jannik"
date: "11/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(lubridate)

fix_emperors <- function(data) {
  data %>% 
    mutate(
      birth = case_when(
        index %in% c(1, 2, 4, 6) ~ update(birth, year = -year(birth)),
        TRUE                     ~ birth
      ),
      reign_start = case_when(
        index == 1 ~ update(reign_start, year = -year(reign_start)),
        TRUE       ~ reign_start
      )
    )
}
```

### Roman emperors

The first exercise uses a dataset about roman emperors
from the tidytuesday project
([link](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-08-13)).
You can import it with:

```{r}
raw_emperors <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-08-13/emperors.csv")
emperors <- fix_emperors(raw_emperors)
```

Here are a couple of questions to answer. Decide
for yourselves if a particular question is best
answered using a visualization, a table
or a simple sentence.

- What was the most popular way to rise to power?

### How they rise

```{r}
rising_to_power <- emperors %>% 
  count(rise, sort = TRUE)
```

```{r}
rising_to_power %>% 
  mutate(rise = fct_reorder(rise, desc(n))) %>% 
  ggplot(aes(n, rise, fill = n)) +
  geom_col() +
  geom_text(aes(label = n), hjust = 1, color = "white") +
  guides(fill = "none") +
  theme_classic()
```

```{r}
rising_to_power %>% 
  mutate(rise = fct_reorder(rise, desc(n))) %>% 
  ggplot(aes(rise, n, fill = n)) +
  geom_col() +
  geom_text(aes(label = n), hjust = 0.5, vjust = 0, color = "black",
            fontface = "bold") +
  guides(fill = "none") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
rising_to_power %>% 
  mutate(
    rise = fct_reorder(rise, desc(n))
    ) %>% 
  arrange(n) %>% 
  mutate(text_position = cumsum(n),
         text_position = text_position - c(0, diff(text_position)) / 2) %>% 
  ggplot(aes(x = 1, y = n, fill = rise)) +
  geom_col(width = 0.4) +
  geom_text(aes(label = n, y = text_position)) +
  coord_polar(theta = "y") +
  theme_void() +
  lims(x = c(0, 2))
```

### How they fall

- I what are the most common causes of death among roman
  emperors, what (or who) killed them?

```{r}
emperors %>% 
  count(cause, killer, sort = TRUE) %>% 
  ggplot(aes(cause, n, fill = killer)) +
  geom_col() +
  fishualize::scale_fill_fish_d()
```

```{r}
most_common_cause <- emperors %>% 
  count(cause, sort = TRUE) %>% 
  pull(cause) %>% 
  head(1)
```

The most common cause was `r most_common_cause`.
  
### Dynamic Dynasties doing their thing

- Which dynasty was the most successful?
  - Firstly, how often did each dynasty reign?
  - Secondly, how long where the reigns?
  - Which dynasty would you rather be a part of,
    if your goal is to live the longest?

```{r}
emperors %>% 
  count(dynasty, sort = TRUE)
```

```{r}
emperors %>% 
  mutate(reign = reign_end - reign_start) %>% 
  group_by(dynasty) %>% 
  summarise(
    top_emperor_reign = max(reign),
    romes_top_emperor = paste(name[reign == top_emperor_reign], collapse = " and "),
    reign = sum(reign)
  )
```

```{r}
mean_lifetime <- emperors %>% 
  mutate(life = death - birth) %>% 
  group_by(dynasty) %>% 
  summarise(life = mean(life, na.rm = TRUE))



new_emperors <- emperors %>% 
  mutate(life = death - birth)

lifetimes_plot <-
  new_emperors %>% 
  ggplot(aes(dynasty, life)) +
  geom_jitter(aes(color = cause, label = name), width = 0.1) +
  geom_point(data = mean_lifetime, color = "red")

plotly::ggplotly(lifetimes_plot)
```

```{r}
emperors %>% 
  mutate(life = death - birth) %>%
  ggplot(aes(dynasty, life)) +
  geom_boxplot()
```

### Dairy Products in the US

Another dataset ([link](https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-01-29#milk_products_facts))
concerns dairy product consumption per person in the US
across a number of years.
Load it with

```{r}
raw_dairy <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-29/milk_products_facts.csv")

dairy <- raw_dairy %>% 
  pivot_longer(-year, names_to = "product",
               values_to = "kg_pp") %>% 
  mutate(kg_pp = kg_pp * 0.4535924)
```

- All masses are given in lbs (pounds),
  can you convert them to kg?
- Which products lost their customer base over time,
  which ones won?

```{r}
dairy <- dairy %>% 
  mutate(product = str_replace_all(product, "_", " "))


milk_plot <- dairy %>% 
  filter(product == "fluid milk") %>% 
  ggplot(aes(year, kg_pp, color = product)) +
  geom_line() +
  geom_point() 
```

```{r}
rest_plot <- dairy %>% 
  filter(product != "fluid milk") %>% 
  ggplot(aes(year, kg_pp, color = product)) +
  geom_line() +
  geom_point()
```

```{r}
library(patchwork)

milk_plot / rest_plot
```

```{r}
modeled_dairy <- dairy %>% 
  nest(-product) %>% 
  mutate(model = map(data, ~ lm(kg_pp ~ year, data = .x)),
         tidy = map(model, broom::tidy)) %>% 
  unnest(tidy) %>% 
  filter(term == "year") %>% 
  unnest(data)

modeled_dairy
```

```{r}
modeled_dairy %>% 
  filter(abs(estimate) > 0.1)
  
```

## Tidy evaluation



```{r}
my_summarise <- function(data, g) {
  data %>% 
    group_by({{g}}) %>% 
    summarise(n = n())
}

my_summarise(emperors, cause)
```


```{r}
emperors %>% 
  mutate(name = fct_reorder(name, reign_end))  %>% 
  ggplot(aes(x = name, ymin = reign_start, ymax = reign_end, color = dynasty,
             group = name)) +
  geom_linerange(size = 3) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size= 5.5))+
  scale_color_brewer(palette = "Set3") +
  labs(y = "Year AD", x = NULL) +
  scale_y_date() +
  coord_flip()
```


```{r}
convert_to_kg <- function(x) x * 0.45

convert_to_kg(12)



```



